<head>
  {{ if .IsHome }}
  <title>{{ .Site.Title }}</title>
  {{ else }}
  <title>{{ .Title }} - {{ .Site.Title }}</title>
  {{ end }}
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  />
  <meta name="theme-color" content="" />
  <meta name="description" content="{{ with .Params.description }}{{ . }}{{ else }}{{ .Site.Params.description }}{{ end }}" />
  <meta name="author" content="{{ .Site.Params.author }}" />

  <!-- Open Graph / Twitter -->
  {{ $title := (cond .IsHome .Site.Title (printf "%s - %s" .Title .Site.Title)) }}
  {{ $desc := (cond (isset .Params "description") .Params.description .Site.Params.description) }}
  {{ $slug := (or .Slug (and .File .File.BaseFileName)) }}
  {{ $ogImg := (cond $slug (printf "/images/og/%s.png" $slug) "/images/og/default.png") | absURL }}
  <meta property="og:type" content="website" />
  <meta property="og:title" content="{{ $title }}" />
  <meta property="og:description" content="{{ $desc }}" />
  <meta property="og:image" content="{{ $ogImg }}" />
  <meta property="og:url" content="{{ .Permalink }}" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="{{ $title }}" />
  <meta name="twitter:description" content="{{ $desc }}" />
  <meta name="twitter:image" content="{{ $ogImg }}" />

  <link rel="icon" href="{{ `favicon.ico` | relURL }}" type="image/x-icon" />
  <link
    rel="stylesheet"
    href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
    integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"
  />
  <link
    rel="stylesheet"
    href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"
  />

  {{ $css := resources.Get "main.css" | css.TailwindCSS }}
  {{ if hugo.IsProduction }}
  {{ with $css | minify | fingerprint }}
  <link
    rel="stylesheet"
    href="{{ .RelPermalink }}"
    integrity="{{ .Data.Integrity | safeHTMLAttr }}"
    crossorigin="anonymous"
  />
  {{ end }}
  {{ else}}
  <link href="{{ $css.RelPermalink }}" rel="stylesheet" />
  {{ end }}

  <!-- Print stylesheet -->
  {{ with resources.Get "print.css" }}
    {{ $print := . }}
    {{ if hugo.IsProduction }}
      {{ with $print | minify | fingerprint }}
        <link rel="stylesheet" media="print" href="{{ .RelPermalink }}" integrity="{{ .Data.Integrity | safeHTMLAttr }}" />
      {{ end }}
    {{ else }}
      <link rel="stylesheet" media="print" href="{{ $print.RelPermalink }}" />
    {{ end }}
  {{ end }}

  <style>
    /* Retain theme inline styles (copied from theme head.html) */
    html { touch-action: manipulation; scroll-behavior: smooth; }
    .panel { max-height: 0; transition: 0.3s ease-out; }
    .profile-photo-container { img { max-width: 100%; } }
    .pagefind-ui__search-input { color: black; width: 100%; padding: 0.5em; border-radius: 0.25em; border: 1px solid gray; }
    .pagefind-ui__search-clear { display: none; }
    .dark .pagefind-ui__search-input { color: white; background-color: #322d2d; width: 100%; padding: 0.5em; border-radius: 0.25em; border: 1px solid gray; }
    .dark .pagefind-ui__search-input::placeholder { color: #8f8f8f; }
    .chevron { transition: 300ms linear rotate; }
    .active > .chevron { transform: rotate(90deg); }
  </style>

  <script>
    const expandAccordion = (elem) => {
      const allPanels = Array.from(document.querySelectorAll(".panel"));
      const allAccordion = Array.from(document.querySelectorAll(".accordion"));

      if (!elem.parentElement.classList.contains("active")) {
        allAccordion.forEach((acc) => { acc.classList.remove("active"); });
        elem.parentElement.classList.add("active");
        allPanels.forEach(function (elem) { elem.style.maxHeight = null; });
        let activePanel = elem.parentElement.nextElementSibling;
        if (activePanel.id != "skill-panel" && document.querySelector("#skill-panel")) {
          let skillBars = Array.from(document.querySelectorAll("#skill-percent"));
          skillBars.forEach((elem) => { elem.style.width = "0"; });
        }
        activePanel.style.maxHeight = activePanel.scrollHeight + "px";

        // Keep the accordion header visible at the top after expansion
        // so longer panels don't push the header off-screen.
        try {
          // Wait for maxHeight transition to complete, then scroll
          setTimeout(() => {
            const headerEl = elem.parentElement;
            const offset = 80; // Increased offset to ensure header stays visible
            const y = headerEl.getBoundingClientRect().top + window.pageYOffset - offset;
            window.scrollTo({ top: y, behavior: 'smooth' });
          }, 50);
        } catch (_) { /* no-op */ }

        // Persist currently opened accordion key for this page
        try {
          const key = (elem.parentElement.textContent || "").trim().toLowerCase().replace(/[^\w]+/g, "-");
          if (key) {
            window.sessionStorage.setItem("openAccordion:" + location.pathname, key);
          }
        } catch (_) { /* no-op */ }
      }
    };
  </script>

  <script>
    let html = document.querySelector("html");
    let theme = window.localStorage.getItem("theme");

    const setTheme = (theme) => {
      html.classList.remove("light");
      if (theme === "dark") {
        html.classList.add("dark");
        window.localStorage.setItem("theme", "dark");
      } else {
        html.classList.remove("dark");
        window.localStorage.setItem("theme", "light");
      }
      fixThemeToggleIcon(theme);
    };

    const fixThemeToggleIcon = (theme) => {
      let themeToggle = document.querySelector(".theme-toggle");
      if (themeToggle) {
        if (theme === "dark") {
          themeToggle.classList.remove("fa-moon");
          themeToggle.classList.add("fa-sun");
        } else {
          themeToggle.classList.remove("fa-sun");
          themeToggle.classList.add("fa-moon");
        }
      }
    };

    if (theme == null) {
      if (html.classList.contains("dark")) {
        theme = "dark";
      } else if (html.classList.contains("light")) {
        theme = "light";
      } else {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        theme = prefersDark ? "dark" : "light";
      }
    }

    setTheme(theme);

    const toggleTheme = () => { html.classList.contains("dark") ? setTheme("light") : setTheme("dark"); };

    // Helper to compute a stable key from an accordion element's label
    const __accordionKey = (el) => {
      return ((el && (el.textContent || "")) || "").trim().toLowerCase().replace(/[^\w]+/g, "-");
    };

    // Before load completes, attach a click handler to capture navigation out of a panel
    document.addEventListener("click", (e) => {
      const linkInPanel = e.target && e.target.closest && e.target.closest(".panel a");
      if (linkInPanel) {
        const activeAcc = document.querySelector(".accordion.active");
        if (activeAcc) {
          try {
            const key = __accordionKey(activeAcc);
            if (key) {
              window.sessionStorage.setItem("openAccordion:" + location.pathname, key);
            }
          } catch (_) { /* no-op */ }
        }
      }
    }, true);

    window.onload = () => {
      fixThemeToggleIcon(theme);
      // Restore previously open accordion for this page if available
      try {
        const storedKey = window.sessionStorage.getItem("openAccordion:" + location.pathname);
        if (storedKey) {
          // Choose only accordion elements that actually control a panel (next sibling is .panel)
          const candidates = Array.from(document.querySelectorAll(".accordion")).filter(el => el.nextElementSibling && el.nextElementSibling.classList && el.nextElementSibling.classList.contains("panel"));
          const match = candidates.find(el => __accordionKey(el) === storedKey);
          if (match) {
            // Clear any pre-set active and expand the stored one
            Array.from(document.querySelectorAll(".accordion")).forEach(acc => acc.classList.remove("active"));
            Array.from(document.querySelectorAll(".panel")).forEach(p => p.style.maxHeight = null);
            match.classList.add("active");
            if (match.nextElementSibling) {
              match.nextElementSibling.style.maxHeight = match.nextElementSibling.scrollHeight + "px";
            }
          }
        }
      } catch (_) { /* no-op */ }

      // Ensure the active panel (default or restored) is expanded
      let defaultActivePanel = document.querySelector(".accordion.active");
      if (defaultActivePanel && defaultActivePanel.nextElementSibling) {
        defaultActivePanel.nextElementSibling.style.maxHeight = defaultActivePanel.nextElementSibling.scrollHeight + "px";
      }
    };

    window.onresize = () => {
      let defaultActivePanel = document.querySelector(".accordion.active");
      if (defaultActivePanel && defaultActivePanel.nextElementSibling) {
        defaultActivePanel.nextElementSibling.style.maxHeight = defaultActivePanel.nextElementSibling.scrollHeight + "px";
      }
    };
  </script>
</head>
